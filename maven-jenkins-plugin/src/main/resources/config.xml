<?xml version='1.0' encoding='UTF-8'?>

<%
import com.goldin.plugins.jenkins.*
import com.goldin.plugins.jenkins.beans.*
import com.goldin.plugins.jenkins.Job.*
import com.goldin.plugins.jenkins.Job.JOB_TYPE
import com.goldin.plugins.common.*
import static com.goldin.plugins.common.GMojoUtils.*
%>

    <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
    <!-- Generated automatically by [${ job.generationPom }] ${ timestamp ?: '' } -->
    <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

<${ ( job.jobType == JOB_TYPE.maven ) ? 'maven2-moduleset' : 'project' }>
  <actions/>
  <description>
       <![CDATA[
<center>
    <h4>
    Job definition is generated by <a href="${ job.generationPom }">Maven</a> ${ timestamp ?: '' }
    <br/>
    If you <a href="${ job.jenkinsUrl + '/job/' + job.id + '/configure' }">configure</a> this project manually - it will probably be <a href="${ job.generationPom }">overwritten</a>!
    </h4>
</center>
${ job.description.trimMultiline() }
<p/>
${ job.htmlDescriptionTable.trimMultiline() }
       ]]>
  </description>
  <%
      if (( job.daysToKeep > -1 ) || ( job.numToKeep > -1 ))
      {
  %>
  <logRotator>
    <daysToKeep>${ job.daysToKeep }</daysToKeep>
    <numToKeep>${ job.numToKeep }</numToKeep>
  </logRotator>
  <%
      }
  %>
  <keepDependencies>false</keepDependencies>
  <properties>
  <%
      if ( job.properties )  { print job.properties.addDollar() }
      if ( job.parameters()) { print getTemplate( '/parameters.xml' ).make([ job : job ]) }
  %>
  </properties>
  <scm class="${ job.scmClass }">
  <%
     if ( job.scmClass.contains( 'CVSSCM' ))
     {
        job.repositories().each
        {
            repository ->
  %>
      <!-- ~~~~~~~~~~~~~~ -->
      <!-- CVS repository -->
      <!-- ~~~~~~~~~~~~~~ -->

        <cvsroot>${ repository.remote }</cvsroot>
        ${ repository.cvsModule ? '<module>' + repository.cvsModule + '</module>' : '' }
        ${ repository.cvsBranch ? '<branch>' + repository.cvsBranch + '</branch>' : '' }
        ${ repository.cvsRsh    ? '<cvsRsh>' + repository.cvsRsh    + '</cvsRsh>' : '' }
        <canUseUpdate>${ repository.cvsUpdate }</canUseUpdate>
        <flatten>${ ! repository.cvsLegacy }</flatten>
        <isTag>${ repository.cvsTag }</isTag>
        <excludedRegions>${ repository.cvsExcludedRegions }</excludedRegions>
  <%
            if ( repository.cvsRepositoryBrowser && repository.cvsRepositoryBrowserUrl )
            {
  %>
        <repositoryBrowser class="${ repository.cvsRepositoryBrowserClass }">
            <url>${ repository.cvsRepositoryBrowserUrl }</url>
        </repositoryBrowser>
  <%
            }
        }
     }
     else if ( job.scmClass.contains( 'SubversionSCM' ))
     {
  %>
    <!-- ~~~~~~~~~~~~~~ -->
    <!-- SVN repository -->
    <!-- ~~~~~~~~~~~~~~ -->

    <locations>
        <%
           job.repositories().each
           {
                repository ->
        %>
      <${ job.scmClass }_-ModuleLocation>
        <remote>${ repository.remote }</remote>
        ${ repository.local ? ( "<local>" + repository.local + "</local>" ) :  "" }
      </${ job.scmClass }_-ModuleLocation>
        <%
           }
        %>
    </locations>
    <useUpdate>${ job.useUpdate }</useUpdate>
    <doRevert>${ job.doRevert }</doRevert>
  <%
     }
     else if ( job.scmClass.contains( 'GitSCM' ))
     {
  %>
    <!-- ~~~~~~~~~~~~~~ -->
    <!-- Git repository -->
    <!-- ~~~~~~~~~~~~~~ -->

    <configVersion>1</configVersion>
    <remoteRepositories>
        <%
           job.repositories().each
           {
                repository ->
        %>
      <org.spearce.jgit.transport.RemoteConfig>
        <string>${ repository.gitName }</string>
        <int>5</int>
        <string>fetch</string>
        <string>${ repository.gitRefspec }</string>
        <string>receivepack</string>
        <string>git-upload-pack</string>
        <string>uploadpack</string>
        <string>git-upload-pack</string>
        <string>url</string>
        <string>${ repository.remote }</string>
        <string>tagopt</string>
        <string></string>
      </org.spearce.jgit.transport.RemoteConfig>
        <%
           }
        %>
    </remoteRepositories>
    <branches>
      <hudson.plugins.git.BranchSpec>
        <name>${ job.repositories().first().gitBranch }</name>
      </hudson.plugins.git.BranchSpec>
    </branches>
    <localBranch></localBranch>
    <mergeOptions/>
    <doGenerateSubmoduleConfigurations>false</doGenerateSubmoduleConfigurations>
    <authorOrCommitter>false</authorOrCommitter>
    <clean>false</clean>
    <wipeOutWorkspace>false</wipeOutWorkspace>
    <buildChooser class="hudson.plugins.git.util.DefaultBuildChooser"/>
    <gitTool>Default</gitTool>
    <submoduleCfg class="list"/>
    <relativeTargetDir></relativeTargetDir>
    <excludedRegions></excludedRegions>
    <excludedUsers></excludedUsers>
  <%
     }

     if ( job.scm )
     {
        print job.scm.addDollar()
     }
  %>
  </scm>

  <assignedNode>${ job.node ?: '' }</assignedNode>
  <canRoam>${ job.node ? false : true }</canRoam>
  <disabled>${ job.disabled }</disabled>
  <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
  <%
     if ( job.authToken )
     {
  %>
  <authToken>${job.authToken}</authToken>
  <%
     }
  %>
  <triggers class="vector">
  <%
     job.triggers().each
     {
         Trigger trigger ->
  %>
        <${ trigger.triggerClass }>
            <spec>${ trigger.description ? '# ' + trigger.description + '\n' : '' }${ trigger.expression }</spec>
        </${ trigger.triggerClass }>
  <%
     }
  %>
  </triggers>
  <jdk>${ job.jdkName }</jdk>
  <concurrentBuild>false</concurrentBuild>
  <%
        if ( job.jobType == JOB_TYPE.maven )
        {
  %>
  <rootPOM>${ job.pom }</rootPOM>
  <goals>${ job.mavenGoals }</goals>
  <mavenName>${ job.mavenName }</mavenName>
  <mavenOpts>${ job.mavenOpts ?: '' }</mavenOpts>
  <aggregatorStyleBuild>true</aggregatorStyleBuild>
  <incrementalBuild>false</incrementalBuild>
  <usePrivateRepository>${ job.privateRepository }</usePrivateRepository>
  <ignoreUpstremChanges>${ ! job.buildOnSNAPSHOT }</ignoreUpstremChanges>
  <archivingDisabled>${ job.archivingDisabled }</archivingDisabled>
  <reporters>
  <%
            if ( job.reporters )
            {
                print job.reporters.addDollar()
            }
            if ( job.mail?.recipients )
            {
  %>
      <hudson.maven.reporters.MavenMailer>
        <recipients>${ job.mail.recipients }</recipients>
        <dontNotifyEveryUnstableBuild>${ ! job.mail.sendForUnstable }</dontNotifyEveryUnstableBuild>
        <sendToIndividuals>${ job.mail.sendToIndividuals }</sendToIndividuals>
      </hudson.maven.reporters.MavenMailer>
  <%
            }
  %>
  </reporters>
  <%
        }
        else if ( job.jobType == JOB_TYPE.free )
        {
  %>
  <builders>
  <%
            for ( task in job.tasks )
            {
  %>
    <${ task.hudsonClass }>
        ${ task.markup }
    </${ task.hudsonClass }>
  <%
            }
  %>
  </builders>
  <%
        }
  %>


  <publishers>
  <%
      if ( job.publishers )
      {
            print job.publishers.addDollar()
      }

      if (( job.mail?.recipients ) && ( job.jobType != JOB_TYPE.maven ))
      {
  %>
      <hudson.tasks.Mailer>
          <recipients>${ job.mail.recipients }</recipients>
          <dontNotifyEveryUnstableBuild>${ ! job.mail.sendForUnstable }</dontNotifyEveryUnstableBuild>
          <sendToIndividuals>${ job.mail.sendToIndividuals }</sendToIndividuals>
      </hudson.tasks.Mailer>
  <%
      }

      if (( job.deploy?.url ) && ( job.jobType == JOB_TYPE.maven ))
      {
  %>
      <hudson.maven.RedeployPublisher>
          <id>${ job.deploy.id }</id>
          <url>${ job.deploy.url }</url>
          <uniqueVersion>${ job.deploy.uniqueVersion }</uniqueVersion>
          <evenIfUnstable>${ job.deploy.evenIfUnstable }</evenIfUnstable>
      </hudson.maven.RedeployPublisher>
  <%
      }

      if (( job.artifactory?.name ) && ( job.jobType == JOB_TYPE.maven ))
      {
  %>
        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
        <!-- Requires "Artifactory Plugin" v2.0.0                          -->
        <!-- http://wiki.jenkins-ci.org/display/JENKINS/Artifactory+Plugin -->
        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
        <org.jfrog.hudson.ArtifactoryRedeployPublisher>
            <details>
                <artifactoryName>${ job.artifactory.name }</artifactoryName>
                <repositoryKey>${ job.artifactory.repository.addDollar() }</repositoryKey>
                <snapshotsRepositoryKey>${ job.artifactory.snapshotsRepository.addDollar() }</snapshotsRepositoryKey>
            </details>
            <deployArtifacts>${ job.artifactory.deployArtifacts }</deployArtifacts>
            <username>${ job.artifactory.user }</username>
            <scrambledPassword>${ job.artifactory.scrambledPassword }</scrambledPassword>
            <includeEnvVars>${ job.artifactory.includeEnvVars }</includeEnvVars>
            <skipBuildInfoDeploy>${ job.artifactory.skipBuildInfoDeploy }</skipBuildInfoDeploy>
            <evenIfUnstable>${ job.artifactory.evenIfUnstable }</evenIfUnstable>
            <runChecks>${ job.artifactory.runChecks }</runChecks>
            <violationRecipients>${ job.artifactory.violationRecipients }</violationRecipients>
        </org.jfrog.hudson.ArtifactoryRedeployPublisher>
  <%
      }

      if ( job.invoke?.jobs )
      {
         def anyConfigs = ( job.invoke.currentBuildParams || job.invoke.subversionRevisionParam ||
                            job.invoke.gitCommitParam     || job.invoke.params                  ||
                            job.invoke.propertiesFileParams )
  %>
        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
        <!-- Requires "Parameterized Trigger Plugin" v2.8                            -->
        <!-- http://wiki.jenkins-ci.org/display/JENKINS/Parameterized+Trigger+Plugin -->
        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
        <hudson.plugins.parameterizedtrigger.BuildTrigger>
            <configs>
                <hudson.plugins.parameterizedtrigger.BuildTriggerConfig>
                    <% if ( ! anyConfigs ) { %>
                    <configs class="java.util.Collections\$EmptyList"/>
                    <% } else { %>
                    <configs>
                        <% if ( job.invoke.currentBuildParams      ) { %><hudson.plugins.parameterizedtrigger.CurrentBuildParameters/><% } %>
                        <% if ( job.invoke.subversionRevisionParam ) { %><hudson.plugins.parameterizedtrigger.SubversionRevisionBuildParameters/><% } %>
                        <% if ( job.invoke.gitCommitParam          ) { %><hudson.plugins.git.GitRevisionBuildParameters/><% } %>
                        <% if ( job.invoke.params ) { %>
                            <hudson.plugins.parameterizedtrigger.PredefinedBuildParameters>
                                <properties>${ job.invoke.params.readLines()*.trim().join( '\n' ) }</properties>
                            </hudson.plugins.parameterizedtrigger.PredefinedBuildParameters>
                        <% } %>
                        <% if ( job.invoke.propertiesFileParams ) { %>
                            <hudson.plugins.parameterizedtrigger.FileBuildParameters>
                                <propertiesFile>${ job.invoke.propertiesFileParams }</propertiesFile>
                            </hudson.plugins.parameterizedtrigger.FileBuildParameters>
                        <% } %>
                    </configs>
                    <% } %>
                    <projects>${ job.invoke.jobs }</projects>
                    <condition>${ job.invoke.condition[ 0 ] }</condition>
                    <triggerWithNoParameters>${ job.invoke.triggerWithoutParameters }</triggerWithNoParameters>
                </hudson.plugins.parameterizedtrigger.BuildTriggerConfig>
            </configs>
        </hudson.plugins.parameterizedtrigger.BuildTrigger>
  <%
       }
  %>

  </publishers>
  <buildWrappers>
  <%
      if ( job.buildWrappers )
      {
          print job.buildWrappers.addDollar()
      }
  %>
  </buildWrappers>
</${ ( job.jobType == JOB_TYPE.maven ) ? 'maven2-moduleset' : 'project' }>
