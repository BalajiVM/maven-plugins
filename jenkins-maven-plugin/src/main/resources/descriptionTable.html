<%
import com.github.goldin.plugins.jenkins.*
import com.github.goldin.plugins.jenkins.beans.*
import com.github.goldin.plugins.jenkins.Job.*
import com.github.goldin.plugins.jenkins.Job.JobType

String jobLink ( String jobId )
{
    assert jenkinsUrl && jobId
    "<a href='$jenkinsUrl/job/$jobId'><strong>$jobId</strong></a>"
}

String tableRow ( String title, String value, boolean code = false, boolean quotes = false )
{
    final valueQuoted = ( quotes ? '"' + value + '"' : value )
    value ? """|<tr>
               |     <td valign='top'>$title</td>
               |     <td>${ code ? ( '<strong><code>' + valueQuoted + '</code></strong>' ) : valueQuoted }</td>
               |</tr>""".stripMargin() :
            ''
}

String tasks ( Task[] tasks )
{
    assert tasks

    ( tasks.size() == 1 ) ?
        "- <strong>${ tasks[ 0 ].descriptionTableTitle }</strong> : &quot;<code>${ tasks[ 0 ].commandShortened }</code>&quot;"
        :
        "<table>" +
        tasks.collect{ "<tr><td>- <strong>${ it.descriptionTableTitle }</strong></td><td> : </td><td>&quot;<code>${ it.commandShortened }</code>&quot;</td></tr>" }.join( '' ) +
        "</table>"
}
%>

<table border='1' width='100%' cellpadding='3' cellspacing='3'>
    <tr>
        <td width='15%' valign='top'>Job</td>
        <td width='85%'>${ jobLink( job.id ) }</td>
    </tr>
    <%
        for ( row in job.descriptionTable.findAll{ ! it.bottom } )
        {
    %>
    ${ tableRow( row.key, row.value ) }
    <%
        }
    %>
    ${ tableRow( 'Display name', job.displayName           ) }
    ${ tableRow( 'Parent job',   job.parent ? ( job.parentIsReal ? jobLink( job.parent ) : job.parent ) : '' ) }
    ${ tableRow( 'Child job' + ( job.childJobs.size() == 1 ? '' : 's' ), job.childJobs.collect{ jobLink( it.id ) }.join( ', ' )) }
    ${ tableRow( 'Job type',     job.jobType.description ) }
    ${ tableRow( 'Node',         '<a href=\'' + job.jenkinsUrl + '/label/' + job.node + '\'/><strong>' + job.node + '</strong></a>' ) }
    ${ tableRow( 'Quiet period', job.quietPeriod,           true ) }
    ${ tableRow( 'Retry count',  job.scmCheckoutRetryCount, true ) }
    ${ tableRow( 'JDK name',     job.jdkName,               true, true ) }
    <%
        if ( job.jobType == JobType.maven )
        {
            final repoPath = ( job.privateRepository ?            ".jenkins/jobs/${ job.id }/workspace/.repository" :
                               job.privateRepositoryPerExecutor ? '.jenkins/maven-repositories/X'                   :
                               job.localRepoPath                ? job.localRepoPath                                 :
                                                                  '.m2/repository' )

            if ( job.prebuildersTasks )
            {
    %>
    <tr>
        <td valign='top'>Pre-build steps</td>
        <td>
        ${ tasks( job.prebuildersTasks ) }
        </td>
    </tr>
    <%
            }
    %>
    ${ tableRow( 'Maven name',       job.mavenName,  true, true ) }
    ${ tableRow( 'Maven goals',      job.mavenGoals, true ) }
    ${ tableRow( 'Maven repository', repoPath,       true, true ) }
    ${ tableRow( 'Maven options',    job.mavenOpts,  true ) }
    <%
            if ( job.postbuildersTasks )
            {
    %>
    <tr>
    <td valign='top'>Post-build steps</td>
        <td>
        ${ tasks( job.postbuildersTasks ) }
        </td>
    </tr>
    <%
            }
            if ( job.artifactory?.name )
            {
    %>
    <tr>
        <td valign='top'>Deployed to Artifactory</td>
        <td><a href='${ job.artifactory.name }'>
            <strong><code>${ job.artifactory.name }</code></strong>
            </a> =>
            <a href='${ job.artifactory.name }/${ job.artifactory.repository }/'>
            <strong><code>"${ job.artifactory.repository }"</code></strong>
            </a>
        </td>
    </tr>
    <%
            }
        }
    %>
    ${ tableRow( 'Mail recipients', job.mail?.recipients, true ) }
    <%
        if ( job.scmType == 'svn' )
        {
    %>
    <tr>
        <td valign='top'>Svn update policy</td>
        <td>Revert - [${ job.doRevert }], update - [${ job.useUpdate }], checkout - [${ ! job.useUpdate }]</td>
    </tr>
    <%
        }
        if ( job.triggers())
        {
    %>
    <tr>
        <td valign='top'>Triggers</td>
        <td>
    <%
                job.triggers().each
                {
                    Trigger trigger ->
    %>
            - <strong><code>${ trigger.type }</code></strong>${ trigger.expression ? ': <code>"' + trigger.expression + '"</code>' : '' }${ trigger.description ? ' <em>(' + trigger.description + ')</em>' : '' }<br/>
    <%
                }
    %>
        </td>
    </tr>
    <%
        }
        else if ( job.jobType == JobType.free )
        {
    %>
    <tr>
    <td valign='top'>Build steps</td>
        <td>
        ${ tasks( job.tasks ) }
        </td>
    </tr>
    <%
        }

        if ( job.repositories())
        {
    %>
    <tr>
        <td valign='top'>${ job.scmType.capitalize() } repositor${ ( job.repositories().size == 1 ) ? 'y' : 'ies' }</td>
        <td>
    <%
            job.repositories().each
            {
                Repository repo ->
    %>

            - <a href='${ repo.remoteLink }/'><strong><code>${ repo.remote }</code></strong></a>
    <%
                if ( repo.git )
                {
    %>
                : <a href='${ repo.gitRemoteBranchLink }/'><strong><code>${ repo.gitBranch }</code></strong></a><br/>
    <%
                }
            }
    %>
        </td>
    </tr>
    <%
            if ( job.pom ) // Free-Style jobs may not use Maven. Even if they use it - its POM is configured inside Maven <task>
            {
                String pomUrl = job.repositories().first().getRemotePathLink( job.pom )
    %>
    ${ tableRow( 'POM', '- <a href=\'' + pomUrl + '\'><strong><code>' + pomUrl + '</code></strong></a><br/>' ) }
    <%
            }
        }
        if ( job.invoke?.jobs )
        {
    %>
    <tr>
        <td valign='top'>Invokes</td>
        <td>
    <%
            job.invoke.jobsSplit.each
            {
                String invokedJobId ->
    %>
            - ${ jobLink( invokedJobId ) } when this job ${ job.invoke.condition[ 1 ] }<br/>
    <%
            }
    %>
        </td>
    </tr>
    <%
        }
        if ( job.invokedBy )
        {
    %>
    <tr>
        <td valign='top'>Invoked by</td>
        <td>
    <%
            job.invokedBy.each
            {
                Job invokedBy ->
    %>
            - ${ jobLink( invokedBy.id ) } when it ${ invokedBy.invoke.condition[ 1 ] }<br/>
    <%
            }
    %>
        </td>
    </tr>
    <%
        }
        for ( row in job.descriptionTable.findAll{ it.bottom } )
        {
    %>
    ${ tableRow( row.key, row.value ) }
    <%
        }
    %>
</table>
