<%
import com.github.goldin.plugins.jenkins.*
import com.github.goldin.plugins.jenkins.beans.*
import com.github.goldin.plugins.jenkins.Job.*
import com.github.goldin.plugins.jenkins.Job.JobType

String jobLink ( String jenkinsUrl, String jobId )
{
    assert jenkinsUrl && jobId
    "<a href='${ jenkinsUrl }/job/${ jobId }'><strong>${ jobId }</strong></a>"
}

String tableRow ( String title, String value, boolean isCode = false )
{
    if ( value )
    {
        """|<tr>
           |     <td valign='top'>$title</td>
           |     <td>${ isCode ? '<strong><code>' + value + '</code></strong>' : value }</td>
           |</tr>""".stripMargin()
    }
    else
    {
        ''
    }
}

%>

<table border="1" width="100%" cellpadding="3" cellspacing="3">
    <%
        for ( row in job.descriptionTable.findAll{ ! it.bottom } )
        {
    %>
    <tr>
        <td  width="15%" valign='top'>${ row.key }</td>
        <td>${ row.value }</td>
    </tr>
    <%
        }
    %>
    <tr>
        <td  width="15%" valign='top'>Job</td>
        <td>${ jobLink( job.jenkinsUrl, job.id ) }</td>
    </tr>
    ${ tableRow( 'Display name', job.displayName           ) }
    ${ tableRow( 'Parent',       job.parent ? ( job.parentIsReal ? jobLink( job.jenkinsUrl, job.parent ) : job.parent ) : '' ) }
    ${ tableRow( 'Quiet period', job.quietPeriod,           true ) }
    ${ tableRow( 'Retry count',  job.scmCheckoutRetryCount, true ) }
    <tr>
        <td valign='top'>Job type</td>
        <td>${ job.jobType.description }</td>
    </tr>
    ${ tableRow( 'JDK name', ( job.jdkName ? '"' + job.jdkName + '"' : '' ), true ) }
    <%
        if ( job.jobType == JobType.maven )
        {
            def repoPath = ( job.privateRepository ? "&lt;user-home&gt;/.jenkins/jobs/${ job.id }/workspace/.repository" :
                             job.localRepoPath     ? job.localRepoPath :
                                                     "&lt;user-home&gt;/.m2/repository" )
    %>
    ${ tableRow( 'Maven name', ( job.mavenName ? '"' + job.mavenName + '"' : '' ), true ) }
    <tr>
        <td valign='top'>Maven goals</td>
        <td><strong><code>${ job.mavenGoals }</code></strong></td>
    </tr>
    <tr>
        <td valign='top'>Maven repository</td>
        <td><strong><code>"${ repoPath }"</code></strong></td>
    </tr>
    ${ tableRow( 'Maven options', job.mavenOpts, true ) }
    <%
            if ( job.artifactory?.name )
            {
    %>
    <tr>
        <td valign='top'>Deployed to Artifactory</td>
        <td><a href="${ job.artifactory.name }">
            <strong><code>${ job.artifactory.name }</code></strong>
            </a> =>
            <a href="${ job.artifactory.name }/${ job.artifactory.repository }/">
            <strong><code>"${ job.artifactory.repository }"</code></strong>
            </a>
        </td>
    </tr>
    <%
            }
        }
    %>
    ${ tableRow( 'Mail recipients', job.mail?.recipients, true ) }
    <%
        if ( job.scmType == 'svn' )
        {
    %>
    <tr>
        <td valign='top'>SVN update policy</td>
        <td>Revert - [${ job.doRevert }], update - [${ job.useUpdate }], checkout - [${ ! job.useUpdate }]</td>
    </tr>
    <%
        }
    %>
    <tr>
        <td valign='top'>Node</td>
        <td><a href="${ job.jenkinsUrl }/label/${ job.node }/"><strong>${ job.node }</strong></a></td>
    </tr>
    <%
        if ( job.triggers())
        {
    %>
    <tr>
        <td valign='top'>Triggers</td>
        <td>
            <%
                job.triggers().each
                {
                    Trigger trigger ->
            %>
            - <strong><code>${ trigger.type }</code></strong>${ trigger.expression ? ': <code>"' + trigger.expression + '"</code>' : '' }${ trigger.description ? ' <em>(' + trigger.description + ')</em>' : '' }<br/>
            <%
                }
            %>
        </td>
    </tr>
    <%
        }
        if ( job.repositories())
        {
    %>
    <tr>
        <td valign='top'>Repositories</td>
        <td>
            <%
                job.repositories().each
                {
                    Repository repo ->
            %>

            - <a href="${ repo.remoteLink }/"><strong><code>${ repo.remote }</code></strong></a>
                <% if ( repo.git ) { %>
                : <a href="${ repo.gitRemoteBranchLink }/">
                  <strong><code>${ repo.gitBranch }</code></strong>
                  </a><br/>
            <%
                   }

                }
                if ( job.pom ) // Free-Style jobs may not use Maven. Even if they use it - its POM is configured inside Maven <task>
                {
                    String pomUrl = job.repositories().first().getRemotePathLink( job.pom )
            %>
        </td>
    </tr>
    <tr>
        <td valign='top'>POM</td>
        <td>
            - <a href="${ pomUrl }"><strong><code>${ pomUrl }</code></strong></a><br/>
        </td>
    </tr>
    <%
                }
        }
        if ( job.invoke?.jobs )
        {
    %>
    <tr>
        <td valign='top'>Invokes</td>
        <td>
            <%
                job.invoke.jobsSplit.each
                {
                    String invokedJobId ->
            %>
            - ${ jobLink( job.jenkinsUrl, invokedJobId ) } when this job ${ job.invoke.condition[ 1 ] }<br/>
            <%
                }
            %>
        </td>
    </tr>
    <%
        }
        if ( job.invokedBy )
        {
    %>
    <tr>
        <td valign='top'>Invoked by</td>
        <td>
            <%
                job.invokedBy.each
                {
                    Job invokedBy ->
            %>
            - ${ jobLink( invokedBy.jenkinsUrl, invokedBy.id ) } when it ${ invokedBy.invoke.condition[ 1 ] }<br/>
            <%
                }
            %>
        </td>
    </tr>
    <%
        }
        for ( row in job.descriptionTable.findAll{ it.bottom } )
        {
    %>
    <tr>
        <td valign='top'>${ row.key }</td>
        <td>${ row.value }</td>
    </tr>
    <%
        }
    %>
</table>
