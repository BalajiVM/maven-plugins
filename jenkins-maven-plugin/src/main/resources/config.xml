<?xml version='1.0' encoding='UTF-8'?>

<%
import static com.github.goldin.plugins.common.GMojoUtils.*
import com.github.goldin.plugins.jenkins.*
import com.github.goldin.plugins.jenkins.beans.*
import com.github.goldin.plugins.jenkins.Job.*
import com.github.goldin.plugins.jenkins.Job.JobType
import com.github.goldin.plugins.common.*
%>

    <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
    <!-- Generated automatically by [${ job.generationPom }] ${ timestamp ?: '' } -->
    <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

<${ ( job.jobType == JobType.maven ) ? 'maven2-moduleset' : 'project' }>
  <actions/>
  <description><![CDATA[<center>
    <h4>
    Job definition is generated by <a href="${ job.generationPom }">Maven</a>
    using <a href="http://evgeny-goldin.com/wiki/Maven-jenkins-plugin">"jenkins-maven-plugin"</a> ${ timestamp ?: '' }.
    <br/>
    If you <a href="${ job.jenkinsUrl + '/job/' + job.id + '/configure' }">configure</a> this project manually -
    it will probably be <a href="${ job.generationPom }">overwritten</a>!
    </h4>
</center>
${ job.description.trimMultiline() }
<p/>
${ job.descriptionTableMarkup.trimMultiline() }]]></description>
  <%
      if ( job.displayName )
      {
  %>
  <displayName>${ job.displayName }</displayName>
  <%
      }
      if ( [ job.daysToKeep, job.numToKeep, job.artifactDaysToKeep, job.artifactNumToKeep ].any{ it > -1 } )
      {
  %>
  <logRotator>
      <daysToKeep>${ job.daysToKeep }</daysToKeep>
      <numToKeep>${ job.numToKeep }</numToKeep>
      <artifactDaysToKeep>${ job.artifactDaysToKeep }</artifactDaysToKeep>
      <artifactNumToKeep>${ job.artifactNumToKeep }</artifactNumToKeep>
  </logRotator>
  <%
      }
  %>
  <keepDependencies>false</keepDependencies>
  <properties>
      ${ job.properties.addDollar() }
  <%
      if ( job.parameters()) { print getTemplate( '/parameters.xml' ).make([ job : job ]) }
      if ( job.gitHubUrl )
      {
  %>
      <com.coravy.hudson.plugins.github.GithubProjectProperty>
        <projectUrl>${ job.gitHubUrl }</projectUrl>
      </com.coravy.hudson.plugins.github.GithubProjectProperty>
  <%
      }
  %>
  </properties>
  <scm class="${ job.scmClass }">
  <%
     if ( job.scmClass.contains( 'CVSSCM' ))
     {
        job.repositories().each
        {
            repository ->
  %>
      <!-- ~~~~~~~~~~~~~~ -->
      <!-- CVS repository -->
      <!-- ~~~~~~~~~~~~~~ -->

        <cvsroot>${ repository.remote }</cvsroot>
        ${ repository.cvsModule ? '<module>' + repository.cvsModule + '</module>' : '' }
        ${ repository.cvsBranch ? '<branch>' + repository.cvsBranch + '</branch>' : '' }
        ${ repository.cvsRsh    ? '<cvsRsh>' + repository.cvsRsh    + '</cvsRsh>' : '' }
        <canUseUpdate>${ repository.cvsUpdate }</canUseUpdate>
        <flatten>${ ! repository.cvsLegacy }</flatten>
  <%
            if ( repository.cvsRepositoryBrowser && repository.cvsRepositoryBrowserUrl )
            {
  %>
        <repositoryBrowser class="${ repository.cvsRepositoryBrowserClass }">
            <url>${ repository.cvsRepositoryBrowserUrl }</url>
        </repositoryBrowser>
  <%
            }
  %>
        <isTag>${ repository.cvsTag }</isTag>
        <excludedRegions>${ repository.cvsExcludedRegions }</excludedRegions>
  <%
        }
     }
     else if ( job.scmClass.contains( 'SubversionSCM' ))
     {
  %>
    <!-- ~~~~~~~~~~~~~~ -->
    <!-- SVN repository -->
    <!-- ~~~~~~~~~~~~~~ -->

    <locations>
        <%
           job.repositories().each
           {
                repository ->
        %>
      <${ job.scmClass }_-ModuleLocation>
        <remote>${ repository.remote }</remote>
        ${ repository.local ? ( '<local>' + repository.local + '</local>' ) :  '' }
      </${ job.scmClass }_-ModuleLocation>
        <%
           }
        %>
    </locations>
    <useUpdate>${ job.useUpdate }</useUpdate>
    <doRevert>${ job.doRevert }</doRevert>
  <%
     }
     else if ( job.scmClass.contains( 'GitSCM' ))
     {
  %>
    <!-- ~~~~~~~~~~~~~~ -->
    <!-- Git repository -->
    <!-- ~~~~~~~~~~~~~~ -->

    <configVersion>2</configVersion>
    <userRemoteConfigs>
    <%
        job.repositories().each
        {
            repository ->
    %>
        <hudson.plugins.git.UserRemoteConfig>
            <name>${ repository.gitName }</name>
            <refspec>${ repository.gitRefspec }</refspec>
            <url>${ repository.remote }</url>
        </hudson.plugins.git.UserRemoteConfig>
    <%
        }
    %>
    </userRemoteConfigs>
    <branches>
    <%
        job.repositories().each
        {
            repository ->
    %>
        <hudson.plugins.git.BranchSpec>
            <name>${ repository.gitBranch }</name>
        </hudson.plugins.git.BranchSpec>
    <%
        }

        def gitRepo = job.repositories().first()
    %>
    </branches>
    ${ gitRepo.gitLocalBranch ? '<localBranch>' + gitRepo.gitLocalBranch + '</localBranch>' : '' }
    <%
        if ( gitRepo.gitMergeRepo || gitRepo.gitMergeBranch )
        {
    %>
    <userMergeOptions>
      <mergeRemote>${ gitRepo.gitMergeRepo }</mergeRemote>
      <mergeTarget>${ gitRepo.gitMergeBranch }</mergeTarget>
    </userMergeOptions>
    <%
        }
    %>
    <recursiveSubmodules>${ gitRepo.gitUpdateSubmodules }</recursiveSubmodules>
    <doGenerateSubmoduleConfigurations>false</doGenerateSubmoduleConfigurations>
    <authorOrCommitter>${ gitRepo.gitCommitAuthor }</authorOrCommitter>
    <clean>${ gitRepo.gitCleanAfterCheckout }</clean>
    <wipeOutWorkspace>${ gitRepo.gitWipeOutWorkspace }</wipeOutWorkspace>
    <pruneBranches>${ gitRepo.gitPruneBranches }</pruneBranches>
    <remotePoll>${ gitRepo.gitRemotePolling }</remotePoll>
    <buildChooser class="hudson.plugins.git.util.DefaultBuildChooser"/>
    <gitTool>Default</gitTool>
    <%
        if ( gitRepo.gitRepoBrowserClass() && gitRepo.gitRepoBrowserUrl )
        {
    %>
    <browser class="${ gitRepo.gitRepoBrowserClass() }">
      <url>${ gitRepo.gitRepoBrowserUrl }</url>
    </browser>
    <%
        }
    %>
    <submoduleCfg class="list"/>
    <relativeTargetDir>${ gitRepo.gitLocalSubdirectory }</relativeTargetDir>
    <excludedRegions>${ gitRepo.gitExcludedRegions }</excludedRegions>
    <excludedUsers>${ gitRepo.gitExcludedUsers }</excludedUsers>
    <gitConfigName>${ gitRepo.gitConfigName }</gitConfigName>
    <gitConfigEmail>${ gitRepo.gitConfigEmail }</gitConfigEmail>
    <skipTag>${ gitRepo.gitSkipTag }</skipTag>
    <scmName>${ gitRepo.gitScmName }</scmName>
     <%
     }
     %>
     ${ job.scm.addDollar() }
  </scm>
  <%
      if ( job.quietPeriod )
      {
  %>
  <quietPeriod>${ job.quietPeriod }</quietPeriod>
  <%
      }
      if ( job.scmCheckoutRetryCount )
      {
  %>
  <scmCheckoutRetryCount>${ job.scmCheckoutRetryCount }</scmCheckoutRetryCount>
  <%
      }
  %>
  <assignedNode>${ job.node ?: '' }</assignedNode>
  <canRoam>${ job.node ? false : true }</canRoam>
  <disabled>${ job.disabled }</disabled>
  <blockBuildWhenDownstreamBuilding>${ job.blockBuildWhenDownstreamBuilding }</blockBuildWhenDownstreamBuilding>
  <blockBuildWhenUpstreamBuilding>${ job.blockBuildWhenUpstreamBuilding }</blockBuildWhenUpstreamBuilding>
  <jdk>${ job.jdkName }</jdk>
  <%
     if ( job.authToken )
     {
  %>
  <authToken>${job.authToken}</authToken>
  <%
     }
  %>
  <triggers class="vector">
  <%
     job.triggers().each
     {
         Trigger trigger ->
  %>
        <${ trigger.triggerClass }>
            <spec>${ trigger.description ? '# ' + trigger.description + '\n' : '' }${ trigger.expression }</spec>
        </${ trigger.triggerClass }>
  <%
     }
  %>
  </triggers>
  <concurrentBuild>false</concurrentBuild>
  <%
        if ( job.jobType == JobType.maven )
        {
  %>
  <rootPOM>${ job.pom }</rootPOM>
  <goals>${ job.mavenGoals }</goals>
  <mavenName>${ job.mavenName }</mavenName>
  <mavenOpts>${ job.mavenOpts ?: '' }</mavenOpts>
  <aggregatorStyleBuild>true</aggregatorStyleBuild>
  <incrementalBuild>${ job.incrementalBuild }</incrementalBuild>
  <localRepository class="hudson.maven.local_repo.${ job.privateRepository            ? 'PerJobLocalRepositoryLocator'      :
                                                     job.privateRepositoryPerExecutor ? 'PerExecutorLocalRepositoryLocator' :
                                                                                        'DefaultLocalRepositoryLocator' }"/>
  <ignoreUpstremChanges>${ ! job.buildOnSNAPSHOT }</ignoreUpstremChanges>
  <archivingDisabled>${ job.archivingDisabled }</archivingDisabled>
  <resolveDependencies>false</resolveDependencies>
  <processPlugins>false</processPlugins>
  <mavenValidationLevel>0</mavenValidationLevel>
  <runHeadless>false</runHeadless>
  <reporters>
      ${ job.reporters.addDollar() }
  <%
        if ( job.mail?.recipients )
        {
  %>
      <hudson.maven.reporters.MavenMailer>
        <recipients>${ job.mail.recipients }</recipients>
        <dontNotifyEveryUnstableBuild>${ ! job.mail.sendForUnstable }</dontNotifyEveryUnstableBuild>
        <sendToIndividuals>${ job.mail.sendToIndividuals }</sendToIndividuals>
      </hudson.maven.reporters.MavenMailer>
  <%
        }
  %>
  </reporters>
  <%
        }
        else if ( job.jobType == JobType.free )
        {
  %>
  <builders>
${ job.tasks*.markup.join( '\n' ) }
  </builders>
  <%
        }
  %>
  <publishers>
${ job.publishers.addDollar() }
  <%
      if (( job.mail?.recipients ) && ( job.jobType != JobType.maven ))
      {
  %>
      <hudson.tasks.Mailer>
          <recipients>${ job.mail.recipients }</recipients>
          <dontNotifyEveryUnstableBuild>${ ! job.mail.sendForUnstable }</dontNotifyEveryUnstableBuild>
          <sendToIndividuals>${ job.mail.sendToIndividuals }</sendToIndividuals>
      </hudson.tasks.Mailer>
  <%
      }

      if (( job.deploy?.url ) && ( job.jobType == JobType.maven ))
      {
  %>
      <hudson.maven.RedeployPublisher>
          <id>${ job.deploy.id }</id>
          <url>${ job.deploy.url }</url>
          <uniqueVersion>${ job.deploy.uniqueVersion }</uniqueVersion>
          <evenIfUnstable>${ job.deploy.evenIfUnstable }</evenIfUnstable>
      </hudson.maven.RedeployPublisher>
  <%
      }

      if (( job.artifactory?.name ) && ( job.jobType == JobType.maven ))
      {
  %>
        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
        <!-- Requires "Artifactory Plugin" v2.0.0                          -->
        <!-- http://wiki.jenkins-ci.org/display/JENKINS/Artifactory+Plugin -->
        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
        <org.jfrog.hudson.ArtifactoryRedeployPublisher>
            <details>
                <artifactoryName>${ job.artifactory.name }</artifactoryName>
                <repositoryKey>${ job.artifactory.repository.addDollar() }</repositoryKey>
                <snapshotsRepositoryKey>${ job.artifactory.snapshotsRepository.addDollar() }</snapshotsRepositoryKey>
            </details>
            <deployArtifacts>${ job.artifactory.deployArtifacts }</deployArtifacts>
            <username>${ job.artifactory.user }</username>
            <scrambledPassword>${ job.artifactory.scrambledPassword }</scrambledPassword>
            <includeEnvVars>${ job.artifactory.includeEnvVars }</includeEnvVars>
            <skipBuildInfoDeploy>${ job.artifactory.skipBuildInfoDeploy }</skipBuildInfoDeploy>
            <evenIfUnstable>${ job.artifactory.evenIfUnstable }</evenIfUnstable>
            <runChecks>${ job.artifactory.runChecks }</runChecks>
            <violationRecipients>${ job.artifactory.violationRecipients }</violationRecipients>
        </org.jfrog.hudson.ArtifactoryRedeployPublisher>
  <%
      }

      if ( job.invoke?.jobs )
      {
         def anyConfigs = ( job.invoke.currentBuildParams || job.invoke.subversionRevisionParam ||
                            job.invoke.gitCommitParam     || job.invoke.params                  ||
                            job.invoke.propertiesFileParams )
  %>
        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
        <!-- Requires "Parameterized Trigger Plugin" v2.8                            -->
        <!-- http://wiki.jenkins-ci.org/display/JENKINS/Parameterized+Trigger+Plugin -->
        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
        <hudson.plugins.parameterizedtrigger.BuildTrigger>
            <configs>
                <hudson.plugins.parameterizedtrigger.BuildTriggerConfig>
                    <% if ( ! anyConfigs ) { %>
                    <configs class="java.util.Collections\$EmptyList"/>
                    <% } else { %>
                    <configs>
                        <% if ( job.invoke.currentBuildParams      ) { %><hudson.plugins.parameterizedtrigger.CurrentBuildParameters/><% } %>
                        <% if ( job.invoke.subversionRevisionParam ) { %><hudson.plugins.parameterizedtrigger.SubversionRevisionBuildParameters/><% } %>
                        <% if ( job.invoke.gitCommitParam          ) { %><hudson.plugins.git.GitRevisionBuildParameters/><% } %>
                        <% if ( job.invoke.params ) { %>
                            <hudson.plugins.parameterizedtrigger.PredefinedBuildParameters>
                                <properties>${ job.invoke.params.readLines()*.trim().join( '\n' ) }</properties>
                            </hudson.plugins.parameterizedtrigger.PredefinedBuildParameters>
                        <% } %>
                        <% if ( job.invoke.propertiesFileParams ) { %>
                            <hudson.plugins.parameterizedtrigger.FileBuildParameters>
                                <propertiesFile>${ job.invoke.propertiesFileParams }</propertiesFile>
                            </hudson.plugins.parameterizedtrigger.FileBuildParameters>
                        <% } %>
                    </configs>
                    <% } %>
                    <projects>${ job.invoke.jobs }</projects>
                    <condition>${ job.invoke.condition[ 0 ] }</condition>
                    <triggerWithNoParameters>${ job.invoke.triggerWithoutParameters }</triggerWithNoParameters>
                </hudson.plugins.parameterizedtrigger.BuildTriggerConfig>
            </configs>
        </hudson.plugins.parameterizedtrigger.BuildTrigger>
  <%
       }
  %>
  </publishers>
  <buildWrappers>
${ job.buildWrappers.addDollar() }
  </buildWrappers>
  <%
      if ( job.jobType == JobType.maven )
      {
  %>
  <prebuilders>
${ ( job.groovys().findAll{ it.pre }*.markup +
     job.prebuildersTasks*.markup            +
     job.prebuilders.addDollar()).join( '\n' ) }
  </prebuilders>
  <postbuilders>
${ ( job.groovys().findAll{ ! it.pre }*.markup +
     job.postbuildersTasks*.markup             +
     job.postbuilders.addDollar()).join( '\n' ) }
  </postbuilders>
  <runPostStepsIfResult>
      <name>${ job.runPostStepsIfResult.name }</name>
      <ordinal>${ job.runPostStepsIfResult.ordinal }</ordinal>
      <color>${ job.runPostStepsIfResult.color }</color>
  </runPostStepsIfResult>
  <%
      }
  %>
</${ ( job.jobType == JobType.maven ) ? 'maven2-moduleset' : 'project' }>
